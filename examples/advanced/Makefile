.PHONY: deps server test clean db-init quick-test help all docker-build docker-up docker-down docker-test docker-logs

# Default target
all: help

# Install Go dependencies
deps:
	@echo "ğŸ“¦ Installing dependencies..."
	@go get github.com/golang-jwt/jwt/v5
	@go get github.com/mattn/go-sqlite3
	@echo "âœ… Dependencies installed"

# Initialize/reset the database
db-init:
	@echo "ğŸ—„ï¸  Initializing database..."
	@rm -f numbers.db
	@echo "âœ… Database reset"

# Start the test server
server: deps
	@echo "ğŸš€ Starting advanced test server on http://localhost:5000"
	@echo "Press Ctrl+C to stop"
	@go run server.go jwt_validator.go

# Run tavern tests
test:
	@echo "ğŸ§ª Running Tavern tests..."
	@../../bin/tavern test_advanced.tavern.yaml

# Run tests with verbose output
test-verbose:
	@echo "ğŸ§ª Running Tavern tests (verbose)..."
	@../../bin/tavern -v test_advanced.tavern.yaml

# Clean up generated files
clean:
	@echo "ğŸ§¹ Cleaning up..."
	@rm -f numbers.db
	@rm -f .server.pid
	@rm -f bin/server
	@echo "âœ… Cleanup complete"

# Build the server binary
build: deps
	@echo "ğŸ”¨ Building server..."
	@mkdir -p bin
	@go build -o bin/server server.go jwt_validator.go
	@echo "âœ… Binary created at bin/server"

# Run the built binary
run-binary: build
	@echo "ğŸš€ Starting server from binary..."
	@./bin/server

# Quick test - start server in background, run tests, stop server
quick-test: deps
	@echo "âš¡ Quick test mode..."
	@echo "Cleaning database..."
	@rm -f numbers.db
	@echo "Starting server in background..."
	@go run server.go jwt_validator.go > /dev/null 2>&1 & echo $$! > .server.pid
	@sleep 3
	@echo "Running tests..."
	@../../bin/tavern test_advanced.tavern.yaml || (kill `cat .server.pid` 2>/dev/null && rm -f .server.pid && false)
	@echo "Stopping server..."
	@kill `cat .server.pid` 2>/dev/null || true
	@rm -f .server.pid
	@echo "âœ… Quick test complete"

# Test login endpoint manually
test-login:
	@echo "ğŸ” Testing login endpoint..."
	@curl -X POST http://localhost:5000/login \
		-H 'Content-Type: application/json' \
		-d '{"user":"test-user","password":"correct-password"}' \
		| python3 -m json.tool || cat
	@echo ""

# Docker commands
docker-build:
	@echo "ğŸ³ Building Docker image..."
	@docker compose build
	@echo "âœ… Docker image built"

docker-up:
	@echo "ğŸ³ Starting server with Docker Compose..."
	@docker compose up -d
	@echo "â³ Waiting for server to be healthy..."
	@sleep 5
	@docker compose ps
	@echo "âœ… Server is running at http://localhost:5000"

docker-down:
	@echo "ğŸ³ Stopping Docker containers..."
	@docker compose down
	@echo "âœ… Containers stopped"

docker-logs:
	@echo "ğŸ“‹ Docker container logs:"
	@docker compose logs -f

docker-test: docker-build docker-up
	@echo "ğŸ§ª Running Tavern tests against Docker container..."
	@sleep 3
	@../../bin/tavern test_advanced.tavern.yaml || (make docker-down && false)
	@make docker-down
	@echo "âœ… Docker test complete"

# Show help
help:
	@echo "ğŸ“– Available commands:"
	@echo ""
	@echo "  make deps         - Install Go dependencies"
	@echo "  make server       - Start the test server"
	@echo "  make test         - Run Tavern tests (server must be running)"
	@echo "  make test-verbose - Run tests with verbose output"
	@echo "  make db-init      - Reset the database"
	@echo "  make build        - Build server binary"
	@echo "  make quick-test   - Auto start server, test, and stop"
	@echo "  make test-login   - Test login endpoint manually"
	@echo "  make clean        - Clean up temporary files"
	@echo ""
	@echo "ğŸ³ Docker commands:"
	@echo "  make docker-build - Build Docker image"
	@echo "  make docker-up    - Start server in Docker"
	@echo "  make docker-down  - Stop Docker containers"
	@echo "  make docker-logs  - View Docker container logs"
	@echo "  make docker-test  - Build, start, test, and stop (automated)"
	@echo "  make help         - Show this help message"
	@echo ""
	@echo "ğŸ’¡ Typical workflow:"
	@echo "  1. make deps      - First time setup"
	@echo "  2. Terminal 1: make server"
	@echo "  3. Terminal 2: make test"
	@echo ""
	@echo "âš¡ Or use: make quick-test (automated)"
	@echo ""
	@echo "ğŸ” Features:"
	@echo "  - JWT Authentication"
	@echo "  - SQLite Database"
	@echo "  - Multi-stage Tests"
	@echo "  - Variable Passing"
	@echo "  - YAML Anchors & Includes"
