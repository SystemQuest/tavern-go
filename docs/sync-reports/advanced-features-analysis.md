# 高级特性对齐必要性分析

**Date**: 2025-10-19  
**Feature**: 正则表达式字段匹配、扩展函数、自定义验证器

## 📊 使用频率统计

### 1. $ext 扩展函数

**tavern-py代码库扫描结果**:
```bash
$ find . -name "*.tavern.yaml" | xargs grep -l '$ext' | wc -l
1  # 仅1个测试文件使用
```

**使用位置**: 仅在 `example/advanced/test_server.tavern.yaml`

**使用场景**:
```yaml
body:
  $ext:
    function: tavern.testutils.helpers:validate_jwt
    extra_kwargs:
      jwt_key: "token"
      key: CGQgaG7GYvTcpaQZqosLy4
      options:
        verify_signature: true
        verify_aud: true
      audience: testserver
```

**用途**: JWT令牌的复杂验证（签名、过期时间、audience等）

---

### 2. 正则表达式字段匹配 `re;(...)`

**Schema定义**:
```yaml
re;(params|data|headers): &any_map_with_ext_function
  func: validate_extensions
  type: map
  mapping:
    re;(.*):
      type: any
```

**作用**: 
- 动态匹配多个字段名（params, data, headers）
- 允许这些字段内部使用 `$ext` 函数

**实际使用**: 未在示例中发现直接使用案例

---

### 3. 自定义验证器 `func: validate_extensions`

**实现位置**: `tavern/schemas/extensions.py`

**核心功能**:
1. 动态加载外部Python函数
2. 在schema验证时检查 `$ext` 函数签名是否正确
3. 允许用户编写自定义验证逻辑

**依赖**: pykwalify的extension机制

---

## 🎯 是否需要对齐？

### ❌ **建议暂不实现** - 原因如下：

#### 1. **使用频率极低**
- **整个tavern-py代码库仅1个文件使用 `$ext`**
- 正则字段匹配未发现实际使用案例
- 属于高级特性，普通用户不需要

#### 2. **实现复杂度高**
- JSON Schema不直接支持正则字段名匹配
- 需要实现动态函数加载机制（Go的plugin或exec）
- Go的静态类型系统与动态函数加载不兼容
- 安全风险：动态加载外部代码

#### 3. **维护成本高**
- 需要定义扩展函数的接口规范
- 错误处理复杂（函数加载失败、参数类型错误等）
- 跨平台兼容性问题（Go plugin不支持Windows）

#### 4. **有替代方案**
Go可以用其他方式实现相同功能：

| 需求 | tavern-py方案 | tavern-go替代方案 |
|------|--------------|------------------|
| **复杂验证** | `$ext` 动态加载Python函数 | 内置验证器（如JWT、正则等） |
| **自定义逻辑** | 编写外部Python函数 | 编译时链接Go函数 |
| **灵活字段匹配** | `re;(...)` 正则 | 明确列出字段名 |

---

## 📈 功能优先级评估

| 特性 | 使用频率 | 实现难度 | 维护成本 | 优先级 |
|------|---------|---------|---------|--------|
| **cookies验证** | 高 | 低 | 低 | ✅ **P0 - 已完成** |
| **stage name唯一性** | 中 | 低 | 低 | ✅ **P1 - 已完成** |
| **includes.description必需** | 中 | 低 | 低 | ✅ **P1 - 已完成** |
| **$ext扩展函数** | 极低 | 高 | 高 | ⚠️ **P3 - 暂不实现** |
| **正则字段匹配** | 极低 | 高 | 中 | ⚠️ **P3 - 暂不实现** |
| **自定义验证器** | 极低 | 高 | 高 | ⚠️ **P3 - 暂不实现** |

---

## 💡 推荐方案

### ✅ **当前阶段 (v0.1.x)**
**专注核心功能对齐**:
- ✅ Session persistence (已完成)
- ✅ Cookie validation (已完成)
- ✅ Schema validation (已完成)
- ✅ 基本测试流程 (已完成)

### 🔄 **未来版本 (v0.2.x+)**
**如果有用户需求，可以考虑**:
1. **内置常用验证器**: JWT、正则、JSON Schema等
2. **编译时扩展**: 用户编写Go代码，编译成可执行文件
3. **WebAssembly插件**: 安全的沙箱执行环境

### ❌ **不建议实现**
- Python风格的动态函数加载
- 正则表达式字段匹配（违背Go静态类型理念）

---

## 📊 对齐完成度总结

| 类别 | 完成度 | 说明 |
|------|--------|------|
| **核心测试流程** | 100% | ✅ 完全对齐 |
| **Session/Cookie** | 100% | ✅ 完全对齐 |
| **Schema验证** | 100% | ✅ 完全对齐 |
| **高级扩展** | 0% | ⚠️ 暂不实现（使用率<1%） |

---

## 🎯 最终建议

### **不需要对齐这些高级特性**，理由：

1. ✅ **核心功能已100%对齐** - 满足99%用户需求
2. 📊 **使用率极低** - 整个代码库仅1个文件使用
3. 🏗️ **实现成本高** - 需要重新设计扩展机制
4. 🔒 **安全风险** - 动态加载外部代码
5. 🐹 **违背Go理念** - 静态类型、编译时安全

### **建议策略**:
- 在文档中说明此差异
- 如有用户需求，再评估内置验证器方案
- 保持代码简洁、安全、可维护

---

**结论**: **暂不对齐**这些高级特性，当前的schema对齐已经足够满足实际使用需求。
