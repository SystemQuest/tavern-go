# Tavern-py Commit 9767444 同步评估

## Commit 信息
- **Hash**: 976744469dd9367839531435fdf545b69a1d03b1
- **作者**: Michael Boulton <boulton@zoetrope.io>
- **日期**: 2018-02-13
- **描述**: Add schema for mqtt client block

## 变更内容

### 文件变更
- `tavern/mqtt.py`: 注释掉了一些不常用的 MQTT 客户端配置项
- `tavern/schemas/tests.schema.yaml`: 新增 50 行（**新增 MQTT schema**）

## 主要变更

### 1. 新增 MQTT 配置的 Schema 验证

在 `tests.schema.yaml` 中添加了 `mqtt` 配置块的完整 schema：

```yaml
mqtt:
  client:
    client_id: str
    clean_session: bool
    transport: enum[tcp, websockets]
  connect:
    host: str (required)
    port: int
    keepalive: int
  tls:
    enable: bool
```

### 2. 简化 MQTT 客户端配置

注释掉了不常用的配置项：
- `userdata`: 难以使用
- `protocol`: 强制使用 mqttv311

## 变更目的

为 MQTT 协议支持添加 **Schema 验证**，确保：
1. ✅ MQTT 配置格式正确
2. ✅ 必填字段存在（如 `connect.host`）
3. ✅ 枚举值正确（如 `transport` 只能是 tcp 或 websockets）
4. ✅ 类型正确（如 `port` 必须是 int）

## Tavern-go 同步评估

### ❌ 暂不同步

**理由**:

1. **MQTT 功能未实现**
   - 这是 MQTT 支持的第三部分（Schema 验证）
   - tavern-go 不支持 MQTT 协议
   - 暂无需求

2. **Go 的 Schema 验证方式不同**
   - tavern-py 使用 YAML schema 文件
   - tavern-go 使用 Go struct tags 验证
   - 当实现 MQTT 时，直接在 Go struct 中定义即可

### 📋 未来实施参考

如果需要添加 MQTT 支持，Go struct 定义如下：

```go
// pkg/schema/types.go
type TestSpec struct {
    TestName string
    Stages   []Stage
    MQTT     *MQTTConfig `yaml:"mqtt,omitempty" json:"mqtt,omitempty"`
}

type MQTTConfig struct {
    Client  *MQTTClient  `yaml:"client,omitempty"`
    Connect MQTTConnect  `yaml:"connect"`           // required
    TLS     *MQTTTls     `yaml:"tls,omitempty"`
}

type MQTTClient struct {
    ClientID     string `yaml:"client_id,omitempty"`
    CleanSession bool   `yaml:"clean_session,omitempty"`
    Transport    string `yaml:"transport,omitempty"` // tcp or websockets
}

type MQTTConnect struct {
    Host      string `yaml:"host"`                    // required
    Port      int    `yaml:"port,omitempty"`
    Keepalive int    `yaml:"keepalive,omitempty"`
}

type MQTTTls struct {
    Enable bool `yaml:"enable,omitempty"`
}
```

## 结论

- **同步状态**: ❌ 暂不同步
- **需要操作**: 无
- **优先级**: 低（MQTT 功能未实现）
- **依赖**: 需要先实现 commit a4ae88f（MQTT 响应验证）

## 备注

- 这是 MQTT 支持系列的第三个 commit
- 只添加了 schema 验证，没有功能实现
- tavern-go 使用 Go struct tags 实现相同功能
- 当实现 MQTT 时，这个 schema 可作为参考
